<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Конфигуратор блока отзывов Яндекс</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    .config-section,
    .preview-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 25px;
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .description {
      color: #7f8c8d;
      margin-bottom: 25px;
      font-size: 16px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: #3498db;
      outline: none;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    button {
      padding: 14px 25px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background-color: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2980b9;
    }

    .btn-secondary {
      background-color: #ecf0f1;
      color: #2c3e50;
    }

    .btn-secondary:hover {
      background-color: #dde4e6;
    }

    .preview-container {
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      padding: 20px;
      background-color: #f9f9f9;
      min-height: 400px;
      overflow: auto;
    }

    .code-container {
      margin-top: 20px;
      background-color: #2c3e50;
      border-radius: 8px;
      padding: 20px;
      color: #ecf0f1;
      font-family: 'Courier New', monospace;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    .code-container pre {
      white-space: pre-wrap;
      word-break: break-all;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }

    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }

    .section-title {
      font-size: 20px;
      margin-bottom: 15px;
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="config-section">
      <h1>Конфигуратор блока отзывов Яндекс</h1>
      <p class="description">Настройте параметры блока отзывов и зарегистрируйте его в Bitrix24</p>

      <div class="form-group">
        <label for="companyId">ID компании в Яндекс.Картах</label>
        <input type="text" id="companyId" value="45616405414" placeholder="Введите ID компании">
      </div>

      <div class="form-group">
        <label for="limit">Количество отображаемых отзывов</label>
        <input type="number" id="limit" value="12" min="1" max="50">
      </div>

      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="hideNegative" checked>
          <label for="hideNegative">Скрывать негативные отзывы (рейтинг ниже 4)</label>
        </div>
      </div>

      <div class="form-group">
        <label for="sortColumn">Сортировка по полю</label>
        <select id="sortColumn">
          <option value="timestamp" selected>Дата</option>
          <option value="rating">Рейтинг</option>
          <option value="name">Имя автора</option>
        </select>
      </div>

      <div class="form-group">
        <label for="sortOrder">Порядок сортировки</label>
        <select id="sortOrder">
          <option value="desc" selected>По убыванию</option>
          <option value="asc">По возрастанию</option>
        </select>
      </div>

      <div class="buttons">
        <button class="btn-primary" id="generateBtn">Сгенерировать код</button>
        <button class="btn-secondary" id="registerBtn">Зарегистрировать в Bitrix24</button>
      </div>

      <div class="success-message" id="successMessage">
        Блок успешно зарегистрирован в Bitrix24!
      </div>

      <div class="error-message" id="errorMessage">
        Произошла ошибка при регистрации блока.
      </div>
    </div>

    <div class="preview-section">
      <h2 class="section-title">Предпросмотр и код</h2>

      <div class="preview-container" id="previewContainer">
        <p>Здесь будет отображаться предпросмотр блока отзывов</p>
      </div>

      <div class="code-container">
        <pre id="codeOutput">// Сгенерированный код появится здесь</pre>
      </div>
    </div>
  </div>

  <script src="//api.bitrix24.com/api/v1/"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const companyIdInput = document.getElementById('companyId');
      const limitInput = document.getElementById('limit');
      const hideNegativeCheckbox = document.getElementById('hideNegative');
      const sortColumnSelect = document.getElementById('sortColumn');
      const sortOrderSelect = document.getElementById('sortOrder');
      const generateBtn = document.getElementById('generateBtn');
      const registerBtn = document.getElementById('registerBtn');
      const previewContainer = document.getElementById('previewContainer');
      const codeOutput = document.getElementById('codeOutput');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');

      // Функция для генерации кода блока
      // Функция для генерации кода блока
      function generateBlockCode() {
        const config = {
          COMPANY_ID: companyIdInput.value,
          PROXY_URL: "https://app.lead-space.ru/WidgetYandexReviews/api/proxy.php",
          LIMIT: parseInt(limitInput.value),
          HIDE_NEGATIVE: hideNegativeCheckbox.checked,
          SORT: {
            column: sortColumnSelect.value,
            order: sortOrderSelect.value
          }
        };

// Генерация HTML-кода блока с конфигурацией в data-атрибуте
const htmlCode = `<div class="lsyr_app-body" 
                    data-company-id="${config.COMPANY_ID}"
                    data-proxy-url="${config.PROXY_URL}"
                    data-limit="${config.LIMIT}"
                    data-hide-negative="${config.HIDE_NEGATIVE}"
                    data-sort-column="${config.SORT.column}"
                    data-sort-order="${config.SORT.order}">
  <!-- Скрытая конфигурация передана через data-атрибуты -->
  
  <div class="lsyr_review-box lsyr_review-unselectable">
    <div class="lsyr_business-summary-rating-badge-view__rating">
      <span id="companyName">Загрузка...</span>
      <br><br>
      <span id="companyRating">—</span> из 5
    </div>
    <div class="lsyr_business-rating-badge-view__stars" id="companyStars">
      <!-- Stars will be generated here -->
    </div>
    <a target="_blank" href="" id="companyMapLink">
      <!-- Логотип Яндекс.Карт SVG удален для безопасности -->
    </a>
    <div class="lsyr_reviews-count" id="companyCounts">
      <a target="_blank" href="" id="companyCountsLink">на основе — отзывов</a>
    </div>
    <a target="_blank" href="" id="companyReviewLink" class="lsyr_reviews-btn lsyr_reviews-btn-form" rel="nofollow noreferrer noopener">Оставить отзыв</a>
  </div>
  
  <div class="lsyr_review-list">
    <div class="lsyr_slider-viewport">
      <div class="lsyr_slider-track" id="track">
        <!-- Reviews will be generated here -->
      </div>
    </div>
    
    <div class="lsyr_review-bottom">
      <div class="lsyr_buttons">
        <button class="lsyr_button-prev" id="prev" tabindex="0" role="button" aria-label="Previous slide">
          <!-- SVG кнопки "Назад" удален для безопасности -->
        </button>
        <button class="lsyr_button-next" id="next" tabindex="0" role="button" aria-label="Next slide">
          <!-- SVG кнопки "Вперед" удален для безопасности -->
        </button>
      </div>
      <div class="lsyr_pagination lsyr_pagination-clickable lsyr_pagination-bullets lsyr_pagination-horizontal" id="pagination">
        <!-- Pagination bullets will be generated here -->
      </div>
      <div class="lsyr_business-review-view_copy">
        <div>разработано</div>
        <a href="https://lead-space.ru/?utm_source=marketplace.1c-bitrix" target="_blank">
          <!-- Логотип Lead Space SVG удален для безопасности -->
        </a>
      </div>
    </div>
  </div>
</div>`;




        // Генерация JS-кода с конфигурацией
        const jsCode = `function $id(id){ const el=document.getElementById(id); if(!el){ console.warn('⛔ Не найден элемент #'+id); } return el; }
function setHref(id, url){ const el=$id(id); if(el) el.href = url; }
const CONFIG = ${JSON.stringify(config, null, 2)};
const MAPS_BASE = "https://yandex.ru/maps/org";

function resolveProxyUrl() {
  const p = (CONFIG.PROXY_URL||"").trim();
  if (/^https?:\\/\\//i.test(p)) return p;
  if (p.startsWith("/")) return location.origin + p;
  const basePath = location.pathname.replace(/\\/[^\\/]*$/, "/");
  return location.origin + basePath + p;
}

function buildUrl(action){
  const u = new URL(resolveProxyUrl());
  u.searchParams.set("ACTION", action);
  u.searchParams.set("COMPANY_ID", CONFIG.COMPANY_ID);
  return u.toString();
}

async function fetchJson(url){
  const res = await fetch(url, { headers: { Accept: "application/json" } });
  const ct = (res.headers.get("content-type") || "").toLowerCase();
  const raw = await res.text();
  if (!res.ok) throw new Error('HTTP ' + res.status + '. Body preview: ' + raw.slice(0,220));
  let json;
  try { json = JSON.parse(raw); }
  catch (e) { throw new Error('Ответ не JSON. Content-Type: ' + (ct || "n/a") + '. Превью: ' + raw.slice(0,220)); }
  if (!json || (json.status && json.status !== "success")) {
    throw new Error(json && (json.message || json.error) ? json.message || json.error : "Некорректный JSON-ответ от сервера");
  }
  return json.data || json;
}

function generateStars(rating, size = 16) {
  const fullStars = Math.floor(rating);
  const hasHalf = (rating - fullStars) >= 0.5;
  const emptyStars = 5 - fullStars - (hasHalf ? 1 : 0);
  let html = '';
  for (let i = 0; i < fullStars; i++) {
    html += '<span class="inline-image _loaded icon lsyr_business-rating-badge-view__star _full" aria-hidden="true" role="button" tabindex="-1" style="font-size: 0px; line-height: 0;">' +
      '<svg width="' + size + '" height="' + size + '" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">' +
        '<path fill-rule="evenodd" clip-rule="evenodd" d="M7.985 11.65l-3.707 2.265a.546.546 0 0 1-.814-.598l1.075-4.282L1.42 6.609a.546.546 0 0 1 .29-.976l4.08-.336 1.7-3.966a.546.546 0 0 1 1.004.001l1.687 3.965 4.107.337c.496.04.684.67.29.976l-3.131 2.425 1.073 4.285a.546.546 0 0 1-.814.598L7.985 11.65z" fill="currentColor"/>' +
      '</svg>' +
    '</span>';
  }
  if (hasHalf) {
    html += '<span class="inline-image _loaded icon lsyr_business-rating-badge-view__star _half" aria-hidden="true" role="button" tabindex="-1" style="font-size: 0px; line-height: 0;">' +
      '<svg width="' + size + '" height="' + size + '" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">' +
        '<path fill-rule="evenodd" clip-rule="evenodd" d="M7.985 11.65l-3.707 2.266a.546.546 0 0 1-.814-.598l1.075-4.282L1.42 6.609a.546.546 0 0 1 .29-.975l4.08-.336 1.7-3.966a.546.546 0 0 1 1.004.001l1.687 3.965 4.107.337c.496.04.684.67.29.975l-3.131 2.426 1.073 4.284a.546.546 0 0 1-.814.6l-3.722-2.27z" fill="#CCC"/>' +
        '<path fill-rule="evenodd" clip-rule="evenodd" d="M4.278 13.915l3.707-2.266V1a.538.538 0 0 0-.494.33l-1.7 3.967-4.08.336a.546.546 0 0 0-.29.975l3.118 2.427-1.075 4.282a.546.546 0 0 0 .814.598z" fill="#FC0"/>' +
      '</svg>' +
    '</span>';
  }
  for (let i = 0; i < emptyStars; i++) {
    html += '<span class="inline-image _loaded icon lsyr_business-rating-badge-view__star _empty" aria-hidden="true" role="button" tabindex="-1" style="font-size: 0px; line-height: 0;">' +
      '<svg width="' + size + '" height="' + size + '" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">' +
        '<path fill-rule="evenodd" clip-rule="evenodd" d="M7.985 11.65l-3.707 2.265a.546.546 0 0 1-.814-.598l1.075-4.282L1.42 6.609a.546.546 0 0 1 .29-.976l4.08-.336 1.7-3.966a.546.546 0 0 1 1.004.001l1.687 3.965 4.107.337c.496.04.684.67.29.976l-3.131 2.425 1.073 4.285a.546.546 0 0 1-.814.598L7.985 11.65z" fill="currentColor"/>' +
      '</svg>' +
    '</span>';
  }
  return html;
}

function mapCompany(raw){
  const ratingNum = Number(raw.rating ?? 5) || 5;
  return { name: raw.name || "", rating: Number.isInteger(ratingNum) ? String(ratingNum) : ratingNum.toFixed(1), reviews_count: raw.reviews_count ?? raw.countmarks ?? 0 };
}
function mapReview(r){
  const ts = Number(r.timestamp ?? Date.now()/1000) || Math.floor(Date.now()/1000);
  const date = r.date || new Date(ts*1000).toISOString().slice(0,10);
  return { name: r.name || "Пользователь", image: r.image || r.avatar || "", rating: Number(r.rating ?? 5) || 5, timestamp: ts, date: date, text: r.text || "" };
}
function sortAndFilter(rs){
  let res = rs.slice();
  if (CONFIG.HIDE_NEGATIVE) res = res.filter(x => x.rating >= 4);
  if (CONFIG.SORT && CONFIG.SORT.column){
    const col = CONFIG.SORT.column, dir = (CONFIG.SORT.order || "asc").toLowerCase() === "desc" ? -1 : 1;
    res.sort((a,b) => (a[col] > b[col] ? 1 : -1) * dir);
  }
  if (CONFIG.LIMIT) res = res.slice(0, CONFIG.LIMIT);
  return res;
}
function escapeHtml(s){ return (s || "").replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c])); }
function slideTemplate(r){
  const avatar = r.image ? '<div class="lsyr_user-icon-view__icon" style="background-image:url(' + escapeHtml(r.image) + ')"></div>' : '<div class="lsyr_user-icon-view__icon"></div>';
  return '\\n    <div class="lsyr_slide">\\n      <div class="lsyr_review-item">\\n        <div class="lsyr_business-review-view__info">\\n          <div class="lsyr_business-review-view__author-container">\\n            <div class="lsyr_business-review-view__author-image">\\n              ' + avatar + '\\n            </div>\\n            <div class="lsyr_business-review-view__author-info">\\n              <div class="ls_business-review-view__author-name">' + escapeHtml(r.name) + '</div>\\n            </div>\\n          </div>\\n          <div class="lsyr_business-review-view__header">\\n            <div class="lsyr_business-review-view__rating">\\n              <div class="lsyr_business-rating-badge-view _size_m _weight_medium">\\n                <div class="lsyr_business-rating-badge-view__stars">\\n                  ' + generateStars(r.rating) + '\\n                </div>\\n              </div>\\n            </div>\\n            <span class="lsyr_business-review-view__date">' + escapeHtml(r.date) + '</span>\\n          </div>\\n          <div dir="auto" class="lsyr_business-review-view__body">\\n            <div class="lsyr_items-text" data-readmore="true" data-collapsed-height="120">\\n              ' + escapeHtml(r.text) + '\\n            </div>\\n            <a target="_blank" href="' + MAPS_BASE + '/' + CONFIG.COMPANY_ID + '/reviews/" class="lsyr_review-source-link">Отзыв Яндекс-Карты</a>\\n          </div>\\n        </div>\\n      </div>\\n    </div>';
}
function initReadmore() {
  document.querySelectorAll('[data-readmore="true"]').forEach(el => {
    const collapsedHeight = parseInt(el.dataset.collapsedHeight) || 120;
    if (el.scrollHeight > collapsedHeight + 20) {
      el.style.maxHeight = collapsedHeight + 'px';
      el.style.overflow = 'hidden';
      el.style.position = 'relative';
      const readmoreBtn = document.createElement('a');
      readmoreBtn.href = 'javascript:void(0)';
      readmoreBtn.textContent = 'Показать полностью';
      readmoreBtn.className = 'lsyr-readmore';
      readmoreBtn.style.display = 'block';
      readmoreBtn.style.marginTop = '8px';
      readmoreBtn.style.fontSize = '14px';
      readmoreBtn.style.color = '#007aff';
      readmoreBtn.style.textDecoration = 'none';
      let isExpanded = false;
      readmoreBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (isExpanded) {
          el.style.maxHeight = collapsedHeight + 'px';
          readmoreBtn.textContent = 'Показать полностью';
          isExpanded = false;
        } else {
          el.style.maxHeight = 'none';
          readmoreBtn.textContent = 'Скрыть';
          isExpanded = true;
        }
      });
      el.parentNode.insertBefore(readmoreBtn, el.nextSibling);
    }
  });
}
function initSlider(){
  const track = document.getElementById("track");
  const prev = document.getElementById("prev");
  const next = document.getElementById("next");
  const pag = document.getElementById("pagination");
  const slides = Array.from(track.children);
  if (!slides.length) return;
  function spv(){ return window.innerWidth >= 1024 ? 3 : (window.innerWidth >= 700 ? 2 : 1); }
  let current = 0;
  function pages(){ return Math.max(1, Math.ceil(slides.length / spv())); }
  function goTo(p){
    const page = Math.max(0, Math.min(pages() - 1, p));
    current = page;
    const slideWidth = 100 / spv();
    const offset = -(page * spv() * slideWidth);
    track.style.transform = 'translateX(' + offset + '%)';
    update();
  }
  function rebuildPag(){
    pag.innerHTML = "";
    for (let i = 0; i < pages(); i++){
      const b = document.createElement("span");
      b.className = "lsyr_pagination-bullet" + (i === current ? " lsyr_pagination-bullet-active" : "");
      b.addEventListener("click", () => goTo(i));
      pag.appendChild(b);
    }
  }
  function update(){
    Array.from(pag.children).forEach((b, i) => b.classList.toggle("lsyr_pagination-bullet-active", i === current));
    prev.disabled = current === 0;
    next.disabled = current >= pages() - 1;
  }
  window.addEventListener("resize", () => { rebuildPag(); goTo(Math.min(current, pages() - 1)); });
  prev.addEventListener("click", () => goTo(current - 1));
  next.addEventListener("click", () => goTo(current + 1));
  rebuildPag(); goTo(0);
}
async function preflight(){
  if (location.protocol === "file:") {
    const msg = "Открой через http:// или https:// (сейчас file://). Иначе запросы к proxy не работают.";
    const track = document.getElementById("track");
    if (track) track.innerHTML = '<div style="padding:12px;color:#b00">' + msg + '</div>';
    throw new Error("file-scheme");
  }
  const test = new URL(resolveProxyUrl());
  test.searchParams.set("TEST", "1");
  const r = await fetch(test, { headers: { Accept: "application/json" } });
  const t = await r.text();
  if (!r.ok || !/^\\s*\\{/.test(t)) {
    throw new Error("Прокси недоступен или вернул не JSON: " + r.status + " " + t.slice(0,200));
  }
}
async function main(){
  try {
    await preflight();
    const companyRaw = await fetchJson(buildUrl("PARSE_COMPANY_DIRECT"));
    const company = mapCompany(companyRaw);
    document.getElementById("companyName").textContent = company.name;
    document.getElementById("companyRating").textContent = company.rating;
    document.getElementById("companyStars").innerHTML = generateStars(parseFloat(company.rating), 22);
    document.getElementById("companyCounts").innerHTML = '<a target="_blank" href="' + MAPS_BASE + '/' + CONFIG.COMPANY_ID + '/reviews/">на основе ' + company.reviews_count + ' отзывов</a>';
    const companyUrl = MAPS_BASE + '/' + CONFIG.COMPANY_ID + '/';
    const reviewsUrl = MAPS_BASE + '/' + CONFIG.COMPANY_ID + '/reviews/';
    const addReviewUrl = MAPS_BASE + '/' + CONFIG.COMPANY_ID + '/add-review/';
    setHref("companyMapLink", companyUrl);
    setHref("companyCountsLink", reviewsUrl);
    setHref("companyReviewLink", addReviewUrl);
    const reviewsRaw = await fetchJson(buildUrl("PARSE_REVIEWS_DIRECT"));
    const reviews = sortAndFilter((Array.isArray(reviewsRaw) ? reviewsRaw : reviewsRaw.items || []).map(mapReview));
    const track = document.getElementById("track");
    track.innerHTML = reviews.map(slideTemplate).join("");
    initReadmore();
    initSlider();
  } catch (e) {
    console.error(e);
    const el = document.getElementById("track");
    if(el) {
      el.innerHTML = '<div style="padding:12px;color:#b00;background:#fff3f3;border:1px solid #ffd0d0;border-radius:6px">Ошибка загрузки: ' + (e && e.message ? e.message : e) + '</div>';
    }
  }
}

window.addEventListener("DOMContentLoaded", main);`;

        // Обновление предпросмотра
        previewContainer.innerHTML = htmlCode;

        // Обновление кода для отображения
        codeOutput.textContent = `// HTML-код блока:\n${htmlCode}\n\n// JavaScript-код:\n${jsCode}`;

        // Генерация PHP-массива для регистрации в Bitrix24 с правильными ссылками
        const phpArray = {
          'code': 'yandex_reviews_block',
          'fields': {
            'NAME': 'Блок отзывов Яндекс',
            'DESCRIPTION': 'Блок для отображения отзывов с Яндекс.Карт',
            'SECTIONS': 'cover,about',
            'PREVIEW': 'https://www.bitrix24.ru/images/b24_screen.png',
            'CONTENT': htmlCode
          },
          'manifest': {
            'assets': {
              'css': [
                'https://app.lead-space.ru/WidgetYandexReviews/styles.css'
              ],
              'js': [
                'https://app.lead-space.ru/WidgetYandexReviews/main.js'
              ]
            },
            'nodes': {
              '.lsyr_business-summary-rating-badge-view__rating': {
                'name': 'Рейтинг компании',
                'type': 'text',
              },
              '.lsyr_reviews-count a': {
                'name': 'Ссылка на отзывы',
                'type': 'link',
              },
              '.lsyr_reviews-btn-form': {
                'name': 'Кнопка отзыва',
                'type': 'link',
              }
            },
            'style': {
              '.lsyr_app-body': {
                'name': 'Основной контейнер',
                'type': 'box',
              },
              '.lsyr_review-box': {
                'name': 'Блок с рейтингом',
                'type': 'box',
              },
              '.lsyr_review-list': {
                'name': 'Список отзывов',
                'type': 'box',
              }
            },
            'attrs': {
              '.lsyr_app-body': {
                'name': 'Настройки блока',
                'type': 'dropdown',
                'attribute': 'data-config',
                'items': {
                  'default': 'Стандартный вид',
                  'compact': 'Компактный вид'
                }
              }
            }
          }
        };

        // Сохранение данных для регистрации
        window.blockData = phpArray;
      }
      function registerBlock() {
        if (!window.blockData) {
          alert('Сначала сгенерируйте код блока!');
          return;
        }

        // Convert the blockData object to a JSON string for checkcontent
        const contentString = JSON.stringify(window.blockData);

        // Validate content structure
        BX24.callMethod(
          'landing.repo.checkcontent',
          {
            content: contentString // Pass the stringified content
          },
          function (result) {
            if (result.error()) {
              errorMessage.style.display = 'block';
              successMessage.style.display = 'none'; // Hide success if there's an error
              console.error('CheckContent Error: ', result.error());
            } else {
              console.info('CheckContent Success: ', result.data());

              BX24.callMethod(
                'landing.repo.unregister',
                { code: window.blockData.code },
                function (result) {
                  if (result.error())
                    console.error(result.error());
                  else
                    console.info(result.data());
                }
              );

              BX24.callMethod(
                'landing.repo.register',
                window.blockData, // Pass the original object structure
                function (resultReg) {
                  if (resultReg.error()) {
                    errorMessage.style.display = 'block';
                    successMessage.style.display = 'none'; // Hide success if there's an error
                    console.error('Register Error: ', resultReg.error());
                  } else {
                    successMessage.style.display = 'block';
                    errorMessage.style.display = 'none'; // Hide error on success
                    console.info('Register Success: ', resultReg.data());
                  }
                }
              );
            }
          }
        );
      }

      // Обработчики событий
      generateBtn.addEventListener('click', generateBlockCode);
      registerBtn.addEventListener('click', registerBlock);

      // Генерация кода при загрузке страницы
      generateBlockCode();
    });
  </script>
</body>

</html>